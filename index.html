<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Image Sheet Maker â€“ PWA</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:Arial;background:#f3f4f6;text-align:center;padding:15px}
#drop-area{border:2px dashed #555;padding:20px;border-radius:10px;background:#fff}
#page{width:794px;height:1123px;margin:auto;background:#fff;border:1px solid #aaa;position:relative;overflow:hidden}
.draggable{position:absolute;cursor:move;max-width:400px;touch-action:none}
button,input{padding:10px 16px;font-size:16px;margin:10px}
@media(max-width:820px){
#page{transform:scale(.5);transform-origin:top left}
}
</style>
</head>

<body>

<h2>ðŸ“„ Image â†’ PDF (PWA Installable)</h2>

<input type="file" id="fileInput" multiple accept="image/*">

<div id="drop-area"><b>Drag & Drop Images</b></div>

<h3>Arrange Page</h3>
<div id="page"></div>

<button id="downloadBtn">â¬‡ Download PDF</button>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* ================= PWA SETUP (AUTO) ================= */

// Manifest (runtime)
const manifest={
 name:"Image Sheet Maker",
 short_name:"SheetPDF",
 start_url:".",
 display:"standalone",
 background_color:"#ffffff",
 theme_color:"#2563eb",
 icons:[{
   src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAJYAAACWCAQAAAB0K5nPAAAA",
   sizes:"192x192",
   type:"image/png"
 }]
};
const blob=new Blob([JSON.stringify(manifest)],{type:"application/json"});
const url=URL.createObjectURL(blob);
const link=document.createElement("link");
link.rel="manifest";
link.href=url;
document.head.appendChild(link);

// Service Worker (runtime)
if("serviceWorker" in navigator){
 const sw=`
 self.addEventListener("install",e=>{
   e.waitUntil(caches.open("pwa-cache").then(c=>c.addAll(["./"])))
 });
 self.addEventListener("fetch",e=>{
   e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)))
 });
 `;
 const swBlob=new Blob([sw],{type:"text/javascript"});
 navigator.serviceWorker.register(URL.createObjectURL(swBlob));
}

/* ============== IMAGE TOOL LOGIC ================== */

const page=document.getElementById("page");
const dropArea=document.getElementById("drop-area");
const fileInput=document.getElementById("fileInput");

["dragenter","dragover","dragleave","drop"].forEach(e=>{
 dropArea.addEventListener(e,x=>x.preventDefault());
});

dropArea.ondrop=e=>handleFiles(e.dataTransfer.files);
fileInput.onchange=e=>handleFiles(e.target.files);

function handleFiles(files){
 [...files].forEach(f=>{
  if(!f.type.startsWith("image"))return;
  const img=document.createElement("img");
  img.src=URL.createObjectURL(f);
  img.className="draggable";
  img.style.left="30px";
  img.style.top="30px";
  img.style.width="200px";
  makeDrag(img);
  page.appendChild(img);
 });
}

function makeDrag(el){
 let sx,sy;
 const move=(x,y)=>{
  x=Math.max(0,Math.min(x-sx,page.clientWidth-el.offsetWidth));
  y=Math.max(0,Math.min(y-sy,page.clientHeight-el.offsetHeight));
  el.style.left=x+"px"; el.style.top=y+"px";
 };
 el.onmousedown=e=>{
  sx=e.clientX-el.offsetLeft;
  sy=e.clientY-el.offsetTop;
  document.onmousemove=e=>move(e.clientX,e.clientY);
  document.onmouseup=()=>document.onmousemove=null;
 };
 el.addEventListener("touchstart",e=>{
  let t=e.touches[0];
  sx=t.clientX-el.offsetLeft;
  sy=t.clientY-el.offsetTop;
 });
 el.addEventListener("touchmove",e=>{
  e.preventDefault();
  move(e.touches[0].clientX,e.touches[0].clientY);
 });
 el.onwheel=e=>{
  e.preventDefault();
  el.style.width=Math.max(50,el.offsetWidth+(e.deltaY<0?10:-10))+"px";
 };
}

downloadBtn.onclick=async()=>{
 const c=await html2canvas(page,{scale:2});
 const pdf=new jspdf.jsPDF("p","px",[794,1123]);
 pdf.addImage(c.toDataURL(),"PNG",0,0,794,1123);
 pdf.save("image_sheet.pdf");
};
</script>

</body>
</html>
